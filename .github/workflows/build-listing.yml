name: Build Repo Listing

on: 
  workflow_dispatch:
  release:
     types: [published, created, edited, unpublished, deleted, released]

jobs:
  
  # Build the VPM Listing Website and deploy to GitHub Pages
  build-listing:
    name: build-listing
    runs-on: ubuntu-latest
    steps:
      
      # # Checkout Local Repository
      # - name: Checkout Local Repository
      #   uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac

      # # Checkout Automation Repository without removing prior checkouts
      # - name: Checkout Automation Repository
      #   uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac
      #   with:
      #     repository: vrchat-community/package-list-action
      #     path: ${{ env.pathToCi }}
      #     clean: false

      # # Load cached data from previous runs
      # - name: Restore Cache
      #   uses: actions/cache@704facf57e6136b1bc63b828d79edcd491f0ee84
      #   with:
      #     path: |
      #       ${{ env.pathToCi }}/.nuke/temp
      #       ~/.nuget/packages
      #     key: ${{ runner.os }}-${{ hashFiles('**/global.json', '**/*.csproj') }}
      
      # # Build Package Version Listing with Nuke
      # - name: Build Package Version Listing
      #   run: ${{ env.pathToCi }}/build.cmd BuildRepoListing --root ${{ env.pathToCi }} --list-publish-directory $GITHUB_WORKSPACE/${{ env.listPublishDirectory }} --current-package-name ${{ vars.PACKAGE_NAME }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # # Prepare for GitHub Pages deployment
      # - name: Setup Pages
      #   uses: actions/configure-pages@f156874f8191504dae5b037505266ed5dda6c382
      
      # # Upload the VPM Listing Website to GitHub Pages artifacts
      # - name: Upload Pages Artifact
      #   uses: actions/upload-pages-artifact@a753861a5debcf57bf8b404356158c8e1e33150c
      #   with:
      #     path: ${{ env.listPublishDirectory }}
      
      # # Deploy the uploaded VPM Listing Website to GitHub Pages
      # - name: Deploy to GitHub Pages
      #   id: deployment
      #   uses: actions/deploy-pages@9dbe3824824f8a1377b8e298bafde1a50ede43e5

      # Generate GitHub Apps token
      - name: Generate GitHub Apps token
        id: generate
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PEM }}
      - name: Echo Token
        env:
          TOKEN: ${{ steps.generate.outputs.token }}
        run: |
          echo "TOKEN: ${TOKEN:4}"

      # Trigger repository listing
      - name: Trigger repository listing
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate.outputs.token }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: 'ikuko',
              repo: 'vpm-test',
              workflow_id: 'build-listing.yml',
              ref: 'main',
            })
